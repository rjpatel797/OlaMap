<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>GPS Playback System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- jQuery for API requests -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body,
    html {
      height: 100%;
      font-family: Arial, sans-serif;
    }

    /* Container setup for full layout */
    .container {
      display: flex;
      flex-direction: column;
      height: 93vh;
    }

    /* Navbar styles */
    #navbar-container {
      width: 100%;
      background-color: #333;
      color: white;
      padding: 0;
    }

    /* Flex layout for main content */
    .content {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 725px;
    }

    .controls {
      margin: 3px;
      background: #2c3e50;
      /* Matching navbar background */
      padding: 5px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      gap: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .controls button {
      padding: 5px 15px;
      font-size: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .controls {
      margin: 3px;
      background: #2c3e50;
      padding: 10px;
      border-radius: 8px;
      display: flex;
      gap: 15px;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .datetime-selector {
      display: flex;
      gap: 10px;
    }

    .date-input {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .date-input label {
      color: white;
      font-size: 13px;
      font-weight: 500;
    }

    .date-input input[type="date"] {
      padding: 5px 8px;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      color: #2c3e50;
      background-color: white;
      cursor: pointer;
      outline: none;
    }

    .date-input input[type="date"]:hover {
      background-color: #f8f9fa;
    }

    .date-input input[type="date"]:focus {
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
    }


    .datetime-wrapper {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .date-input input[type="time"] {
      padding: 5px 8px;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      color: #2c3e50;
      background-color: white;
      cursor: pointer;
      outline: none;
    }

    .date-input input[type="time"]:hover {
      background-color: #f8f9fa;
    }

    .date-input input[type="time"]:focus {
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
    }

    .device-selector select {
      padding: 5px 25px 5px 10px;
      font-size: 13px;
      color: #2c3e50;
      background-color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232c3e50' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 12px;
      min-width: 150px;
    }

    .device-selector {
      position: relative;
      width: 250px;
    }

    .dropdown-container {
      position: relative;
    }

    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #ffffff;
      border-radius: 4px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 1000;
    }

    .dropdown-header {
      padding: 10px;
      color: rgb(0, 0, 0);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-weight: 500;
    }

    .dropdown-search {
      padding: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .dropdown-search input {
      width: 100%;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 4px;
      color: rgb(0, 0, 0);
      font-size: 13px;
    }

    .dropdown-search input::placeholder {
      color: rgba(0, 0, 0, 0.5);
    }

    .dropdown-items {
      max-height: 200px;
      overflow-y: auto;
    }

    .dropdown-item {
      padding: 8px 10px;
      color: black;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .dropdown-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Selected Vehicle */
    .selected-vehicle {
      padding: 8px 12px;
      background: #f8f9fa;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      color: rgb(0, 0, 0);
      cursor: pointer;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .selected-vehicle:after {
      content: "▼";
      font-size: 10px;
      margin-left: 8px;
    }

    .device-selector select:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
    }

    .buttonclass {
      display: flex;
      gap: 8px;
    }

    /* Keep your existing button styles */
    .buttonclass button {
      padding: 5px 15px;
      font-size: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    /* Start Button */
    #startPlayback {
      background-color: #2ecc71;
      color: white;
    }

    #startPlayback:hover {
      background-color: #27ae60;
    }

    /* Pause Button */
    #pausePlayback {
      background-color: #f1c40f;
      color: #2c3e50;
    }

    #pausePlayback:hover {
      background-color: #f39c12;
    }

    /* Stop Button */
    #stopPlayback {
      background-color: #e74c3c;
      color: white;
    }

    #stopPlayback:hover {
      background-color: #c0392b;
    }

    /* Add icons to buttons */
    #startPlayback::before {
      content: "▶";
      font-size: 12px;
    }

    #pausePlayback::before {
      content: "⏸";
      font-size: 12px;
    }

    #stopPlayback::before {
      content: "⏹";
      font-size: 12px;
    }

    /* Active state for buttons */
    .controls button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    /* Disabled state */
    .controls button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .controls {
        margin: 10px;
        padding: 10px;
      }

      .controls button {
        padding: 8px 16px;
        font-size: 12px;
      }
    }

    .customMarkerClass {
      display: block !important;
      height: 20px;
      width: 40px;
      position: relative;
      transform-origin: center center;
      transform: translate(-50%, -50%);
      /* Add this to center the marker */
      top: -105px;
      /* Adjust this value to fine-tune vertical position */
    }

    .carImage {
      width: 40px;
      height: 20px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform-origin: center center;
      transform: translate(-50%,
          -50%);
      /* Center the image within the marker */
      display: block;
    }

    #customPopup {
    position: absolute;
    background: #fff;
    padding: 0;  /* Remove all padding */
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.15);
    display: none;
    z-index: 1000;
    min-width: 220px;
    text-align: left;
    transform: translate(-50%, -100%);
    margin-top: -10px;
  }

    #popupContent {
      padding: 0;  /* Remove inner padding */
      line-height: 1.4;
      color: #2c3e50;
      font-size: 12px;
    }

    .vehicle-info {
      display: flex;
      flex-direction: column;
    }

    .info-row {
      display: grid;
      grid-template-columns: 100px auto;
      padding: 4px 12px;  /* Add padding to rows instead */
      align-items: center;
    }

    .info-label {
      color: #64748b;
      font-weight: 500;
      text-transform: uppercase;
      font-size: 12px;
    }

    .info-value {
      color: #1e293b;
      font-weight: 400;
      font-size: 12px;
    }

    /* Status indicators */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      min-width: 35px;
    }

    .status-on {
      background-color: #dcfce7;
      color: #166534;
    }

    .status-off {
      background-color: #fee2e2;
      color: #991b1b;
    }

    /* Arrow indicator */
    #customPopup:after {
      content: "";
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid #fff;
      filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
    }

    .close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #95a5a6;
      font-size: 14px;
      border-radius: 50%;
      z-index: 2;
    }

    /* Arrow indicator */
    /* .popup::after {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid #fff;
        filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
    } */

    .controls {
      margin: 3px;
      background: #2c3e50;
      padding: 5px 15px;
      /* Increased padding */
      border-radius: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .selected-device {
      margin-left: 15px;
      padding: 5px 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      min-width: 200px;
    }

    .device-icon {
      font-size: 16px;
    }

    #deviceNameDisplay {
      font-weight: 500;
      color: #ecf0f1;
    }

    .deviceItem {
      position: relative;
      background-color: #f5f6f7;
      border-radius: 6px;
      margin: 5px 0;
      transition: all 0.3s ease;
    }

    .device-main {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      cursor: pointer;
    }

    .device-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dropdown-arrow {
      font-size: 10px;
      color: #666;
      transition: transform 0.3s ease;
    }

    .device-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: white;
      border-radius: 0 0 6px 6px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 100;
    }

    .device-selector {
      position: relative;
      margin-left: 10px;
    }

    #deviceSelect {
      padding: 5px 35px 5px 15px;
      font-size: 13px;
      color: #fff;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      min-width: 200px;
      height: 32px;
      outline: none;
      transition: all 0.3s ease;
    }

    #deviceSelect:hover {
      background-color: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    #deviceSelect:focus {
      background-color: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .device-selector::after {
      content: "▼";
      font-size: 10px;
      color: #000;
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }

    #deviceSelect option {
      background-color: #2c3e50;
      color: #fff;
      padding: 8px;
    }

    #deviceSelect option:hover {
      background-color: #34495e;
    }

    /* Adjust the existing controls styles */
    .controls {
      margin: 3px;
      background: #2c3e50;
      padding: 5px 15px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .controls button {
      padding: 8px 16px;
      font-size: 13px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    #startPlayback {
      background-color: #2ecc71;
      color: white;
    }

    #startPlayback:hover {
      background-color: #27ae60;
    }

    #pausePlayback {
      background-color: #f1c40f;
      color: #2c3e50;
    }

    #pausePlayback:hover {
      background-color: #f39c12;
    }

    #stopPlayback {
      background-color: #e74c3c;
      color: white;
    }

    #stopPlayback:hover {
      background-color: #c0392b;
    }

    .polyline-popup {
      display: none;
      position: absolute;
      background: white;
      padding: 8px 12px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      color: #333;
      max-width: 200px;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .polyline-popup::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 5px solid white;
    }

    /* pop-up display righ-side*/
    .vehicle-info-popup {
      position: fixed;
      top: 160px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px;
      /* Reduced from 15px */
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      width: 180px;
      /* Reduced from 280px */
      z-index: 9999;
      transition: all 0.3s ease;
    }

    .info-container {
      display: flex;
      flex-direction: column;
      gap: 3px;
      /* Reduced from 12px */
    }

    .info-card {
      display: flex;
      align-items: center;
      padding: 3px;
      /* Reduced from 10px */
      background: white;
      border-radius: 10px;
      transition: transform 0.2s ease;
      border: 1px solid #f0f0f0;
    }

    .info-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .info-icon {
      font-size: 16px;
      /* Reduced from 20px */
      width: 30px;
      /* Reduced from 40px */
      height: 30px;
      /* Reduced from 40px */
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border-radius: 8px;
      margin-right: 8px;
      /* Reduced from 12px */
    }

    .info-details {
      display: flex;
      flex-direction: column;
      gap: 2px;
      /* Reduced from 4px */
    }

    .info-label {
      color: #64748b;
      font-size: 11px;
      /* Reduced from 12px */
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-value {
      color: #1e293b;
      font-size: 13px;
      /* Reduced from 16px */
      font-weight: 600;
    }

    #speedDisplay {
      color: #2563eb;
    }

    #dateTimeDisplay {
      font-size: 12px;
      white-space: nowrap;
    }

    #distanceDisplay {
      color: #059669;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .vehicle-info-popup {
        width: calc(100% - 40px);
        top: auto;
        bottom: 20px;
        right: 20px;
      }

      .info-container {
        flex-direction: row;
        justify-content: space-between;
      }

      .info-card {
        flex: 1;
      }
    }

    .direction-arrow {
      pointer-events: none;
      z-index: 1;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Navbar -->
    <div id="navbar-container"></div>
    <div class="content">
      <div class="controls">
        <div class="datetime-selector">
          <div class="device-selector">
            <div class="dropdown-container">
              <!-- Dropdown Button (Selected Vehicle) -->
              <div class="selected-vehicle" id="selectedVehicle" onclick="toggleDropdown()">
                Select Vehicle
              </div>

              <!-- Dropdown List (Hidden by default) -->
              <div class="dropdown-list" id="deviceDropdown">
                <!-- Search input for filtering vehicles -->
                <div class="dropdown-search">
                  <input type="text" placeholder="Search vehicle..." id="vehicleSearch"
                    onclick="event.stopPropagation()" onkeyup="filterVehicles(this.value)" />
                </div>

                <!-- List of filtered vehicles -->
                <div class="dropdown-items" id="vehicleList">
                  <!-- Vehicles will be populated here dynamically -->
                </div>
              </div>
            </div>
          </div>
          <div class="date-input">
            <label>From:</label>
            <div class="datetime-wrapper">
              <input type="date" id="fromDate" placeholder="dd/mm/yyyy" />
              <input type="time" id="fromTime" value="00:00" />
            </div>
          </div>
          <div class="date-input">
            <label>To:</label>
            <div class="datetime-wrapper">
              <input type="date" id="toDate" placeholder="dd/mm/yyyy" />
              <input type="time" id="toTime" value="23:59" />
            </div>
          </div>
        </div>

        <div class="buttonclass">
          <button id="startPlayback">Start</button>
          <button id="pausePlayback">Pause</button>
          <button id="stopPlayback">Stop</button>
        </div>
      </div>
      <div id="map"></div>
      <div id="polylinePopup" class="polyline-popup">
        <div id="polylinePopupContent"></div>
      </div>

      <!-- Custom Popup Element -->
      <div id="customPopup" class="popup">
        <span class="close-btn" onclick="hidePopup(true)">✖</span>
        <div id="popupContent"></div>
      </div>
    </div>

    <div id="vehicleInfoPopup" class="vehicle-info-popup">
      <div class="info-container">
        <div class="info-card">
          <div class="info-icon">🚗</div>
          <div class="info-details">
            <span class="info-label">Speed</span>
            <span class="info-value" id="speedDisplay">0 km/h</span>
          </div>
        </div>

        <div class="info-card">
          <div class="info-icon">🕒</div>
          <div class="info-details">
            <span class="info-label">Time</span>
            <span class="info-value" id="dateTimeDisplay">--</span>
          </div>
        </div>

        <div class="info-card">
          <div class="info-icon">📍</div>
          <div class="info-details">
            <span class="info-label">Distance</span>
            <span class="info-value" id="distanceDisplay">0 km</span>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="js/api.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjSJzY7GgAuRw_Pf5tUCJU7oMm_rg0aWg&callback=initMap"
    async defer></script>
  <script>
    // Global variables
    let map;
    let vehicleMarker;
    let playbackData = [];
    let pathPolyline;
    let index = 0;
    let playbackInterval;
    let isPaused = false;
    let infoWindow;
    let startMarker;
    let endMarker;
    let totalDistance = 0;
    let devices = [];
    let selectedDeviceId = null;

    const ANGLE_OFFSET = 90;
    //const API = 'YOUR_API_ENDPOINT'; // Replace with your API endpoint

    // Initialize Google Maps
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 23.0225, lng: 72.5714 },
        zoom: 15,
        styles: [
          {
            "featureType": "all",
            "elementType": "geometry",
            "stylers": [{ "visibility": "simplified" }]
          }
        ]
      });

      infoWindow = new google.maps.InfoWindow();

      // Initialize other features after map loads
      google.maps.event.addListenerOnce(map, 'idle', () => {
        fetchDeviceData().catch((error) => {
          console.error("Error fetching device data:", error);
        });
      });
    }

    // Toggle dropdown visibility
    function toggleDropdown() {
      const dropdown = document.getElementById("deviceDropdown");
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    }

    // Filter vehicles
    function filterVehicles(searchText) {
      const filteredDevices = devices.filter(device =>
        device.name.toLowerCase().includes(searchText.toLowerCase())
      );
      populateVehicleList(filteredDevices);
    }

    // Fetch device data
    function fetchDeviceData() {
      const mid = localStorage.getItem("mid");
      if (!mid) {
        console.error("No mid found in localStorage");
        return Promise.reject("No mid found");
      }

      return fetch(`${API}opr=getdevicelistByMid&mid=${mid}`)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(data => {
          if (!Array.isArray(data)) throw new Error("Invalid data format received");

          devices = data.map(item => ({
            name: item.dname,
            did: item.did
          }));
          populateVehicleList(devices);
        })
        .catch(error => {
          console.error("Error fetching vehicles:", error);
          alert("Error loading vehicle list. Please try again.");
        });
    }

    // Populate vehicle list
    function populateVehicleList(devicesList) {
      const vehicleList = document.getElementById("vehicleList");
      vehicleList.innerHTML = "";

      if (!Array.isArray(devicesList) || devicesList.length === 0) {
        const noDevicesMsg = document.createElement("div");
        noDevicesMsg.className = "dropdown-item";
        noDevicesMsg.textContent = "No vehicles available";
        vehicleList.appendChild(noDevicesMsg);
        return;
      }

      devicesList.forEach(device => {
        if (!device.did || !device.name) return;

        const item = document.createElement("div");
        item.className = "dropdown-item";
        item.textContent = device.name;
        item.onclick = (e) => {
          e.stopPropagation();
          selectVehicle(device.did, device.name);
        };
        vehicleList.appendChild(item);
      });
    }

    // Select vehicle
    function selectVehicle(deviceId, deviceName) {
      if (!deviceId) {
        console.error("No Vehicle ID provided");
        return;
      }

      selectedDeviceId = deviceId;
      document.getElementById("selectedVehicle").textContent = deviceName;
      document.getElementById("deviceDropdown").style.display = "none";

      const fromDate = document.getElementById("fromDate").value;
      const toDate = document.getElementById("toDate").value;

      if (fromDate && toDate) {
        fetchPlaybackData(deviceId)
          .then(() => {
            if (playbackData.length) {
              addPolyline();
              addStartEndMarkers();
            }
          })
          .catch(error => {
            console.error("Error fetching playback data:", error);
            alert("Error loading playback data. Please try again.");
          });
      } else {
        alert("Please select both From and To dates");
      }
    }

    // Format date and time
    function formatDate(dateString) {
      const date = new Date(dateString);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    function formatTime(timeString) {
      return timeString.replace(':', '') + '00';
    }

    // Validate coordinates
    function isValidCoordinate(lng, lat) {
      return !isNaN(lng) && !isNaN(lat) &&
        lng >= -180 && lng <= 180 &&
        lat >= -90 && lat <= 90;
    }

    // Fetch playback data
    function fetchPlaybackData(did) {
      if (!did) return Promise.reject("Vehicle ID required");

      const fromDate = document.getElementById("fromDate").value;
      const toDate = document.getElementById("toDate").value;
      const fromTime = document.getElementById("fromTime").value;
      const toTime = document.getElementById("toTime").value;

      if (!fromDate || !toDate) {
        alert("Please select both From and To dates");
        return Promise.reject("Date selection required");
      }

      const formattedFromDateTime = `${formatDate(fromDate)}${formatTime(fromTime)}`;
      const formattedToDateTime = `${formatDate(toDate)}${formatTime(toTime)}`;

      console.log('Fetching data with params:', {
        did,
        fromDateTime: formattedFromDateTime,
        toDateTime: formattedToDateTime
      });

      return fetch(`${API}opr=getplaybacktest&sdate=${formattedFromDateTime}&edate=${formattedToDateTime}&did=${did}`)
        .then(response => response.json())
        .then(data => {
          console.log('Raw API response:', data); // Log raw data

          if (!Array.isArray(data)) {
            console.error('Invalid data format:', data);
            throw new Error("Invalid data format received");
          }

          if (data.length === 0) {
            console.warn('Empty data array received');
            throw new Error("No data received for the selected time period");
          }

          // Log the first item to check structure
          if (data.length > 0) {
            console.log('Sample data item:', data[0]);
          }

          playbackData = data
            .map((item, index) => {
              // Convert and validate coordinates
              const lng = Number(item.langitude);
              const lat = Number(item.latitude);
              const angle = ((Number(item.angle) || 0) % 360 + 360) % 360;

              // Log invalid coordinates for debugging
              if (!isValidCoordinate(lng, lat)) {
                console.warn(`Invalid coordinates at index ${index}:`, {
                  original: { lat: item.latitude, lng: item.langitude },
                  converted: { lat, lng }
                });
                return null;
              }

              return {
                position: { lat, lng },
                angle: angle,
                deviceId: String(item.deviceId),
                speed: Number(item.speed) || 0,
                gps: item.digital_2,
                engine: item.digital_2,
                date: item.DeviceDate
              };
            })
            .filter(Boolean);

          console.log('Processed data points:', playbackData.length);

          if (playbackData.length === 0) {
            throw new Error("No valid coordinates found in data. Check console for details.");
          }

          updateMapView();
          return playbackData;
        })
        .catch(error => {
          // More detailed error logging
          console.error("Error in fetchPlaybackData:", {
            message: error.message,
            error: error,
            requestParams: {
              did,
              fromDateTime: formattedFromDateTime,
              toDateTime: formattedToDateTime
            }
          });

          // More descriptive alert message
          let errorMessage = "Error loading playback data: ";
          if (error.message.includes("No valid coordinates")) {
            errorMessage += "No valid location data found for the selected time period.";
          } else if (error.message.includes("Invalid data format")) {
            errorMessage += "Received unexpected data format from server.";
          } else {
            errorMessage += "Please try again or select a different time period.";
          }

          alert(errorMessage);
          throw error;
        });
    }

    // Helper function to validate coordinates
    function isValidCoordinate(lng, lat) {
      return (
        typeof lng === 'number' &&
        typeof lat === 'number' &&
        !isNaN(lng) &&
        !isNaN(lat) &&
        lng >= -180 &&
        lng <= 180 &&
        lat >= -90 &&
        lat <= 90 &&
        lng !== 0 && // Additional check for 0,0 coordinates
        lat !== 0
      );
    }

    // Update map view
    function updateMapView() {
      if (!playbackData.length) return;

      const bounds = new google.maps.LatLngBounds();
      playbackData.forEach(point => {
        bounds.extend(point.position);
      });

      map.fitBounds(bounds, {
        padding: { top: 50, right: 50, bottom: 50, left: 50 }
      });
    }

    // Create popup content
    function createPopupContent(data, totalDistance) {
      return `
        <div class="vehicle-info">
          <div class="info-row">
            <span class="info-label">Vehicle:</span>
            <span class="info-value">${data.deviceId}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Speed:</span>
            <span class="info-value">${Math.round(data.speed)} km/h</span>
          </div>
          <div class="info-row">
            <span class="info-label">GPS:</span>
            <span class="info-value">
              <span class="status-indicator ${data.gps === "true" ? "status-on" : "status-off"}">
                ${data.gps === "true" ? "ON" : "OFF"}
              </span>
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">Engine:</span>
            <span class="info-value">
              <span class="status-indicator ${data.engine === "true" ? "status-on" : "status-off"}">
                ${data.engine === "true" ? "ON" : "OFF"}
              </span>
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">Date-Time:</span>
            <span class="info-value">${data.date.split(".")[0]}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Distance:</span>
            <span class="info-value">${totalDistance.toFixed(2)} km</span>
          </div>
        </div>`;
    }

    // Update vehicle info panel
    function updateVehicleInfo(data, totalDistance) {
      document.getElementById("speedDisplay").textContent = `${Math.round(data.speed)} km/h`;
      document.getElementById("dateTimeDisplay").textContent = data.date.split(".")[0];
      document.getElementById("distanceDisplay").textContent = `${totalDistance.toFixed(2)} km`;
    }

    // Function to create marker icon
  function createMarkerIcon() {
    return {
      url: '/images/truck1.png#vehicleMarker',
      scaledSize: new google.maps.Size(30, 30),
      anchor: new google.maps.Point(15, 15)
    };
  }

// Function to rotate marker
function rotateMarker(newAngle) {
  if (!vehicleMarker) return;
  
  // Normalize the angle
  newAngle = ((Number(newAngle) % 360) + 360 +90) % 360;
  
  // Apply rotation using CSS transform
  $('img[src$="#vehicleMarker"]').css({
    'transform': `rotate(${newAngle}deg)`,
    'transform-origin': 'center',
    'width': '30px',
    'height': '32px',
    'max-width': '100%',
    'object-fit': 'scale-down'
  });
}

// Function to get current marker rotation
function getMarkerRotation() {
  const markerImg = $('img[src$="#vehicleMarker"]');
  if (!markerImg.length) return 0;
  
  const transform = markerImg.css('transform');
  if (transform === 'none') return 0;
  
  const values = transform.split('(')[1].split(')')[0].split(',');
  const a = values[0];
  const b = values[1];
  const angle = Math.round(Math.atan2(b, a) * (180/Math.PI));
  return ((angle % 360) + 360) % 360;
}

    // Start playback
    function startPlayback() {
      const selectedVehicle = document.getElementById('selectedVehicle');
      if (selectedVehicle.textContent === 'Select Vehicle') {
        alert('Please select a vehicle before starting playback');
        return;
      }

      if (!playbackData || playbackData.length === 0) {
        alert("No playback data available. Please select a vehicle and date range first.");
        return;
      }

      if (playbackInterval) {
        clearInterval(playbackInterval);
        playbackInterval = null;
      }

      if (!isPaused) {
        index = 0;
        totalDistance = 0;
      } else {
        isPaused = false;
      }

      try {
    if (!vehicleMarker) {
      vehicleMarker = new google.maps.Marker({
        map: map,
        icon: createMarkerIcon(),
        optimized: false // Important for smooth rotation
      });

      // Add CSS style for smooth rotation
      const style = document.createElement('style');
      style.textContent = `
        img[src$="#vehicleMarker"] {
          transition: transform 0.1s ease-out;
          transform-origin: center;
        }
      `;
      document.head.appendChild(style);

      vehicleMarker.addListener('click', () => {
        const content = createPopupContent(playbackData[index], calculateCumulativeDistance(index));
        infoWindow.setContent(content);
        infoWindow.open(map, vehicleMarker);
      });
    }

    if (index === 0 && playbackData[0]) {
      vehicleMarker.setPosition(playbackData[0].position);
      rotateMarker(playbackData[0].angle);
    }

    playbackInterval = setInterval(() => {
      if (index >= playbackData.length) {
        clearInterval(playbackInterval);
        return;
      }

      const currentPoint = playbackData[index];
      if (currentPoint) {
        vehicleMarker.setPosition(currentPoint.position);
        map.setCenter(currentPoint.position);
        
        // Apply smooth rotation
        rotateMarker(currentPoint.angle);

        const cumulativeDistance = calculateCumulativeDistance(index);
        updateVehicleInfo(currentPoint, cumulativeDistance);

        if (infoWindow.getMap()) {
          infoWindow.setContent(createPopupContent(currentPoint, cumulativeDistance));
        }
      }

      index++;
    }, 1000);
  } catch (error) {
    console.error("Error in startPlayback:", error);
    alert("Error starting playback. Please try again.");
  }
    }

    const markerStyles = `
.custom-marker {
  position: relative;
  cursor: pointer;
}

.custom-marker img {
  transform-origin: center center;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.gmnoprint img {
  max-width: none !important;
  transform-origin: center center;
}`;

document.head.insertAdjacentHTML('beforeend', `<style>${markerStyles}</style>`);

    // Pause playback
    function pausePlayback() {
      if (playbackInterval) {
        clearInterval(playbackInterval);
        playbackInterval = null;
        isPaused = true;
      }
    }

    // Stop playback
    function stopPlayback() {
      if (playbackInterval) {
        clearInterval(playbackInterval);
        playbackInterval = null;
      }

      index = 0;
      isPaused = false;
      totalDistance = 0;

      // Clear markers
      if (vehicleMarker) {
        vehicleMarker.setMap(null);
        vehicleMarker = null;
      }
      if (startMarker) {
        startMarker.setMap(null);
        startMarker = null;
      }
      if (endMarker) {
        endMarker.setMap(null);
        endMarker = null;
      }

      // Clear polyline
      if (pathPolyline) {
        pathPolyline.setMap(null);
        pathPolyline = null;
      }

      // Reset info displays
      document.getElementById("speedDisplay").textContent = "0 km/h";
      document.getElementById("dateTimeDisplay").textContent = "--";
      document.getElementById("distanceDisplay").textContent = "0.00 km";

      // Close info window
      infoWindow.close();

      // Reset device selection
      document.getElementById("selectedVehicle").textContent = "Select Vehicle";
      selectedDeviceId = null;

      // Reset dates and times to default values
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("fromDate").value = today;
      document.getElementById("toDate").value = today;
      document.getElementById("fromTime").value = "00:00";
      document.getElementById("toTime").value = "23:59";

      // Reset map center to default position
      map.setCenter({ lat: 23.0225, lng: 72.5714 });
      map.setZoom(15);
    }

    // Add start and end markers
    function addStartEndMarkers() {
      if (!playbackData || playbackData.length < 2) return;

      // Remove existing markers
      if (startMarker) startMarker.setMap(null);
      if (endMarker) endMarker.setMap(null);

      const startPoint = playbackData[0];
      const endPoint = playbackData[playbackData.length - 1];

      // Create start marker
      startMarker = new google.maps.Marker({
        position: startPoint.position,
        map: map,
        label: {
          text: 'S',
          color: 'white'
        },
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: '#2ecc71',
          fillOpacity: 1,
          strokeWeight: 2,
          strokeColor: '#ffffff'
        }
      });

      // Create end marker
      endMarker = new google.maps.Marker({
        position: endPoint.position,
        map: map,
        label: {
          text: 'E',
          color: 'white'
        },
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: '#e74c3c',
          fillOpacity: 1,
          strokeWeight: 2,
          strokeColor: '#ffffff'
        }
      });

      // Add timestamps to markers
      const startInfo = new google.maps.InfoWindow({
        content: `<div style="padding: 5px;">Start: ${startPoint.date.split('.')[0]}</div>`
      });

      const endInfo = new google.maps.InfoWindow({
        content: `<div style="padding: 5px;">End: ${endPoint.date.split('.')[0]}</div>`
      });

      startMarker.addListener('mouseover', () => startInfo.open(map, startMarker));
      startMarker.addListener('mouseout', () => startInfo.close());
      endMarker.addListener('mouseover', () => endInfo.open(map, endMarker));
      endMarker.addListener('mouseout', () => endInfo.close());
    }

    // Add polyline to map
    function addPolyline() {
  if (pathPolyline) {
    pathPolyline.setMap(null);
  }

  const path = playbackData.map(point => point.position);

  // Create the polyline
  pathPolyline = new google.maps.Polyline({
    path: path,
    geodesic: true,
    strokeColor: '#FF0000',
    strokeOpacity: 1.0,
    strokeWeight: 2,
    map: map,
    icons: [{
      icon: createArrowSymbol(),
      offset: '50%',
      repeat: '100px'  // Arrows will repeat every 100 pixels
    }]
  });

  // Add hover effect on polyline
  pathPolyline.addListener('mouseover', (e) => {
    pathPolyline.setOptions({
      strokeWeight: 4,
      strokeOpacity: 0.8,
      icons: [{
        icon: createArrowSymbol(),
        offset: '50%',
        repeat: '100px'
      }]
    });
  });

  pathPolyline.addListener('mouseout', () => {
    pathPolyline.setOptions({
      strokeWeight: 2,
      strokeOpacity: 1.0,
      icons: [{
        icon: createArrowSymbol(),
        offset: '50%',
        repeat: '100px'
      }]
    });
  });
}

// Function to create arrow symbol
function createArrowSymbol() {
  return {
    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
    scale: 3,
    strokeColor: '#FFF',
    strokeWeight: 2,
    fillColor: '#000',
    fillOpacity: 1
  };
}
    // Helper functions
    function updateMarkerRotation(angle) {
      if (vehicleMarker) {
        const icon = vehicleMarker.getIcon();
        icon.rotation = (angle + ANGLE_OFFSET) % 360;
        vehicleMarker.setIcon(icon);
      }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in km
      const dLat = (lat2 - lat1) * (Math.PI / 180);
      const dLon = (lon2 - lon1) * (Math.PI / 180);

      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function calculateCumulativeDistance(currentIndex) {
      let distance = 0;
      for (let i = 0; i < currentIndex; i++) {
        const current = playbackData[i];
        const next = playbackData[i + 1];
        if (next) {
          distance += calculateDistance(
            current.position.lat,
            current.position.lng,
            next.position.lat,
            next.position.lng
          );
        }
      }
      return distance;
    }

    // Setup date validation
    function setupDateValidation() {
    const fromDateInput = document.getElementById("fromDate");
    const toDateInput = document.getElementById("toDate");
    const fromTimeInput = document.getElementById("fromTime");
    const toTimeInput = document.getElementById("toTime");

    // Get current date and time
    function getCurrentDateTime() {
        const now = new Date();
        return {
            date: now.toISOString().split('T')[0],
            hours: String(now.getHours()).padStart(2, '0'),
            minutes: String(now.getMinutes()).padStart(2, '0')
        };
    }

    // Set max attribute to current date
    function updateMaxDates() {
        const current = getCurrentDateTime();
        fromDateInput.max = current.date;
        toDateInput.max = current.date;
        
        // Set default values if not already set
        if (!fromDateInput.value) fromDateInput.value = current.date;
        if (!toDateInput.value) toDateInput.value = current.date;
        if (!fromTimeInput.value) fromTimeInput.value = "00:00";
        if (!toTimeInput.value) toTimeInput.value = "23:59";
    }

    // Initial setup
    updateMaxDates();

    // Validate dates
    function validateDates() {
        const current = getCurrentDateTime();
        const currentDate = new Date();
        const fromDate = new Date(fromDateInput.value);
        const toDate = new Date(toDateInput.value);

        // Reset time parts to compare just dates
        fromDate.setHours(0, 0, 0, 0);
        toDate.setHours(0, 0, 0, 0);
        const todayMidnight = new Date(currentDate);
        todayMidnight.setHours(0, 0, 0, 0);

        // Check for future dates
        if (fromDate > todayMidnight || toDate > todayMidnight) {
            alert("Dates cannot be in the future");
            fromDateInput.value = current.date;
            toDateInput.value = current.date;
            return;
        }

        // Check if from date is after to date
        if (fromDate > toDate) {
            alert("From date cannot be after To date");
            toDateInput.value = fromDateInput.value;
        }

        // If dates are current date, validate times
        if (fromDateInput.value === current.date || toDateInput.value === current.date) {
            validateTimes();
        }
    }

    // Validate times
    function validateTimes() {
        const current = getCurrentDateTime();
        const currentTimeStr = `${current.hours}:${current.minutes}`;

        // If selected date is today, prevent future times
        if (fromDateInput.value === current.date) {
            if (fromTimeInput.value > currentTimeStr) {
                alert("Start time cannot be in the future");
                fromTimeInput.value = currentTimeStr;
            }
        }

        if (toDateInput.value === current.date) {
            if (toTimeInput.value > currentTimeStr) {
                toTimeInput.value = currentTimeStr;
            }
        }

        // If same day, ensure from time isn't after to time
        if (fromDateInput.value === toDateInput.value) {
            if (fromTimeInput.value > toTimeInput.value) {
                alert("Start time cannot be after end time");
                toTimeInput.value = fromTimeInput.value;
            }
        }
    }

    // Event listeners
    fromDateInput.addEventListener("change", validateDates);
    toDateInput.addEventListener("change", validateDates);
    fromTimeInput.addEventListener("change", validateTimes);
    toTimeInput.addEventListener("change", validateTimes);

    // Update max dates every minute to keep current
    setInterval(updateMaxDates, 60000);
}
    // Event listeners
    $(document).ready(() => {
      $("#navbar-container").load("navbarola.html", () => {
        console.log("Navbar loaded.");
      });

      window.onload = function () {
        fetchDeviceData(); // Fetch and populate devices when the page loads
      };

      $("#startPlayback").on("click", startPlayback);
      $("#pausePlayback").on("click", pausePlayback);
      $("#stopPlayback").on("click", stopPlayback);

      $("#deviceSelect").on("change", function () {
        const selectedDid = $(this).val();
        if (!selectedDid) return;

        fetchPlaybackData(selectedDid).then(() => {
          if (playbackData.length) {
            addPolyline();
            addStartEndMarkers(pathCoordinates); // Replace addEndpointMarker with this
          }
        });
      });

      // Check if 'mid' is available in localStorage otherwise ri-direct login page
      if (!localStorage.getItem('mid')) {
        // Redirect to login page if 'mid' is not found
        window.location.href = '/index.html';
      }
      setupDateValidation()
    });

    // URL parameter handling
    document.addEventListener('DOMContentLoaded', function () {
      const urlParams = new URLSearchParams(window.location.search);
      const deviceName = urlParams.get('device');
      const fromDate = urlParams.get('from');
      const toDate = urlParams.get('to');

      if (deviceName && fromDate && toDate) {
        const dateInputs = document.querySelectorAll('.date-input input[type="date"]');
        const timeInputs = document.querySelectorAll('.date-input input[type="time"]');

        if (dateInputs.length >= 2) {
          dateInputs[0].value = fromDate;
          dateInputs[1].value = toDate;
          timeInputs[0].value = '00:00';
          timeInputs[1].value = '23:59';
        }

        const checkVehicleList = setInterval(() => {
          const vehicleList = document.getElementById('vehicleList');
          if (vehicleList && vehicleList.children.length > 0) {
            clearInterval(checkVehicleList);
            const deviceElements = vehicleList.querySelectorAll('.dropdown-item');
            for (const element of deviceElements) {
              if (element.textContent.trim() === deviceName) {
                element.click();
                break;
              }
            }
          }
        }, 100);

        setTimeout(() => clearInterval(checkVehicleList), 10000);
      }
    });
  </script>
</body>

</html>