(function(a){a.widget("ui.tagit",{options:{itemName:"item",fieldName:"tags",availableTags:[],tagSource:null,removeConfirmation:false,caseSensitive:true,placeholderText:null,allowSpaces:false,animate:true,singleField:false,singleFieldDelimiter:",",singleFieldNode:null,tabIndex:null,onTagAdded:null,onTagRemoved:null,onTagClicked:null},_create:function(){var b=this;if(this.element.is("input")){this.tagList=a("<ul></ul>").insertAfter(this.element);this.options.singleField=true;this.options.singleFieldNode=this.element;this.element.css("display","none")}else{this.tagList=this.element.find("ul, ol").andSelf().last()}this._tagInput=a('<input type="text" />').addClass("ui-widget-content");if(this.options.tabIndex){this._tagInput.attr("tabindex",this.options.tabIndex)}if(this.options.placeholderText){this._tagInput.attr("placeholder",this.options.placeholderText)}this.options.tagSource=this.options.tagSource||function(b,c){var d=b.term.toLowerCase();var e=a.grep(this.options.availableTags,function(a){return a.toLowerCase().indexOf(d)===0});c(this._subtractArray(e,this.assignedTags()))};if(a.isFunction(this.options.tagSource)){this.options.tagSource=a.proxy(this.options.tagSource,this)}this.tagList.addClass("tagit").addClass("ui-widget ui-widget-content ui-corner-all").append(a('<li class="tagit-new"></li>').append(this._tagInput)).click(function(c){var d=a(c.target);if(d.hasClass("tagit-label")){b._trigger("onTagClicked",c,d.closest(".tagit-choice"))}else{b._tagInput.focus()}});this.tagList.children("li").each(function(){if(!a(this).hasClass("tagit-new")){b.createTag(a(this).html(),a(this).attr("class"));a(this).remove()}});if(this.options.singleField){if(this.options.singleFieldNode){var c=a(this.options.singleFieldNode);var d=c.val().split(this.options.singleFieldDelimiter);c.val("");a.each(d,function(a,c){b.createTag(c)})}else{this.options.singleFieldNode=this.tagList.after('<input type="hidden" style="display:none;" value="" name="'+this.options.fieldName+'" />')}}this._tagInput.keydown(function(c){if(c.which==a.ui.keyCode.BACKSPACE&&b._tagInput.val()===""){var d=b._lastTag();if(!b.options.removeConfirmation||d.hasClass("remove")){b.removeTag(d)}else if(b.options.removeConfirmation){d.addClass("remove ui-state-highlight")}}else if(b.options.removeConfirmation){b._lastTag().removeClass("remove ui-state-highlight")}if(c.which==a.ui.keyCode.COMMA||c.which==a.ui.keyCode.ENTER||c.which==a.ui.keyCode.TAB&&b._tagInput.val()!==""||c.which==a.ui.keyCode.SPACE&&b.options.allowSpaces!==true&&(a.trim(b._tagInput.val()).replace(/^s*/,"").charAt(0)!='"'||a.trim(b._tagInput.val()).charAt(0)=='"'&&a.trim(b._tagInput.val()).charAt(a.trim(b._tagInput.val()).length-1)=='"'&&a.trim(b._tagInput.val()).length-1!==0)){c.preventDefault();b.createTag(b._cleanedInput());b._tagInput.autocomplete("close")}}).blur(function(a){b.createTag(b._cleanedInput())});if(this.options.availableTags||this.options.tagSource){this._tagInput.autocomplete({source:this.options.tagSource,select:function(a,c){if(b._tagInput.val()===""){b.removeTag(b._lastTag(),false)}b.createTag(c.item.value);return false}})}},_cleanedInput:function(){return a.trim(this._tagInput.val().replace(/^"(.*)"$/,"$1"))},_lastTag:function(){return this.tagList.children(".tagit-choice:last")},assignedTags:function(){var b=this;var c=[];if(this.options.singleField){c=a(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter);if(c[0]===""){c=[]}}else{this.tagList.children(".tagit-choice").each(function(){c.push(b.tagLabel(this))})}return c},_updateSingleTagsField:function(b){a(this.options.singleFieldNode).val(b.join(this.options.singleFieldDelimiter))},_subtractArray:function(b,c){var d=[];for(var e=0;e<b.length;e++){if(a.inArray(b[e],c)==-1){d.push(b[e])}}return d},tagLabel:function(b){if(this.options.singleField){return a(b).children(".tagit-label").text()}else{return a(b).children("input").val()}},_isNew:function(a){var b=this;var c=true;this.tagList.children(".tagit-choice").each(function(d){if(b._formatStr(a)==b._formatStr(b.tagLabel(this))){c=false;return false}});return c},_formatStr:function(b){if(this.options.caseSensitive){return b}return a.trim(b.toLowerCase())},createTag:function(b,c){var d=this;b=a.trim(b);if(!this._isNew(b)||b===""){return false}var e=a(this.options.onTagClicked?'<a class="tagit-label"></a>':'<span class="tagit-label"></span>').text(b);var f=a("<li></li>").addClass("tagit-choice ui-widget-content ui-state-default ui-corner-all").addClass(c).append(e);var g=a("<span></span>").addClass("ui-icon ui-icon-close");var h=a('<a><span class="text-icon">×</span></a>').addClass("tagit-close").append(g).click(function(a){d.removeTag(f)});f.append(h);if(this.options.singleField){var i=this.assignedTags();i.push(b);this._updateSingleTagsField(i)}else{var j=e.html();f.append('<input type="hidden" style="display:none;" value="'+j+'" name="'+this.options.itemName+"["+this.options.fieldName+'][]" />')}this._trigger("onTagAdded",null,f);this._tagInput.val("");this._tagInput.parent().before(f)},removeTag:function(b,c){c=c||this.options.animate;b=a(b);this._trigger("onTagRemoved",null,b);if(this.options.singleField){var d=this.assignedTags();var e=this.tagLabel(b);d=a.grep(d,function(a){return a!=e});this._updateSingleTagsField(d)}if(c){b.fadeOut("fast").hide("blind",{direction:"horizontal"},"fast",function(){b.remove()}).dequeue()}else{b.remove()}},removeAll:function(){var a=this;this.tagList.children(".tagit-choice").each(function(b,c){a.removeTag(c,false)})}})})(jQuery)