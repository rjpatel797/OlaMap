<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fence Creator with MapMyIndia</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #navbar-container {
            width: 100%;
            background-color: #333;
            color: white;
            padding: 0;
        }

        .search-bar {
            padding: 15px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1;
        }

        .search-box {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .search-label {
            font-weight: bold;
            color: #333;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .drawing-tools {
            position: absolute;
            top: 80px;
            right: 5px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1;
        }

        .tool-button {
            width: 36px;
            height: 36px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-button.active {
            background: #e3f2fd;
            border-color: #2196F3;
        }

        .name-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }

        .name-popup.active {
            display: block;
        }

        .popup-content {
            min-width: 300px;
        }

        .name-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .popup-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .popup-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .cancel-btn {
            background: #f5f5f5;
        }

        .add-btn {
            background: #2196F3;
            color: white;
        }

        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .suggestion-item:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="navbar-container"></div>
        <div class="search-bar">
            <div class="search-box">
                <label class="search-label">Place:</label>
                <input type="text" id="searchInput" class="search-input" placeholder="Search places...">
                <div id="suggestions" class="suggestions-container"></div>
            </div>
        </div>
        <div class="map-container">
            <div id="map"></div>
            <div class="drawing-tools">
                <button class="tool-button" onclick="setDrawingMode('hand', event)" title="Pan Map">
                    <svg width="800px" height="800px" viewBox="0 0 16 16" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <path fill="#444"
                            d="M13.5 2.4c-0.4-0.4-1-0.5-1.5-0.3 0-0.3-0.1-0.6-0.4-0.9-0.2-0.2-0.6-0.4-1.1-0.4-0.3 0-0.5 0.1-0.7 0.1 0-0.2-0.1-0.3-0.2-0.5-0.5-0.6-1.5-0.6-2 0-0.2 0.2-0.4 0.4-0.4 0.6-0.2 0-0.4-0.1-0.6-0.1-0.5 0-0.8 0.2-1.1 0.5-0.5 0.5-0.5 1.3-0.5 1.3v3.8c-0.3-0.3-0.8-0.8-1.5-0.8-0.2 0-0.5 0.1-0.7 0.2-0.4 0.2-0.6 0.5-0.7 0.9-0.3 1 0.6 2.4 0.6 2.5 0.1 0.1 1.2 2.7 2.2 3.8 1 1.2 2.1 1.9 4.9 1.9 2.9 0 4.2-1.6 4.2-5.1v-5.5c0-0.1 0.1-1.3-0.5-2zM8 2c0-0.3-0.1-1 0.5-1 0.5 0 0.5 0.5 0.5 1v4c0 0.3 0.2 0.5 0.5 0.5s0.5-0.2 0.5-0.5v-3.8c0 0 0-0.4 0.5-0.4 0.6 0 0.5 0.9 0.5 0.9v3.3c0 0.3 0.2 0.5 0.5 0.5s0.5-0.2 0.5-0.5v-2.4c0-0.1 0-0.6 0.5-0.6s0.5 1 0.5 1v5.9c0 3.4-1.3 4.1-3.2 4.1-2.4 0-3.3-0.5-4.1-1.6-0.9-1-2.1-3.6-2.1-3.7-0.3-0.3-0.7-1.2-0.6-1.6 0-0.1 0.1-0.2 0.2-0.3 0.1 0 0.2-0.1 0.2-0.1 0.4 0 0.8 0.5 0.9 0.7l0.6 0.9c0.1 0.2 0.4 0.3 0.6 0.2 0.4 0 0.5-0.2 0.5-0.4v-5.2c0-0.4 0-1 0.5-1 0.4 0 0.5 0.3 0.5 0.8v3.3c0 0.3 0.2 0.5 0.5 0.5s0.5-0.2 0.5-0.5z">
                        </path>
                    </svg>
                </button>
                <button class="tool-button" onclick="setDrawingMode('circle', event)" title="Draw Circle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                    </svg>
                </button>
                <button class="tool-button" onclick="setDrawingMode('polygon', event)" title="Draw Polygon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="name-popup" id="namePopup">
            <div class="popup-content">
                <label for="fenceName">Name:</label>
                <input type="text" id="fenceName" class="name-input">
                <div class="popup-buttons">
                    <button class="popup-button cancel-btn" onclick="cancelFence()">Cancel</button>
                    <button class="popup-button add-btn" onclick="saveFence()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let currentDrawingMode = null;
        let currentShape = null;
        let drawingLayers = [];
        let polygonPath = [];
        let tempPolyline = null;
        let circleMarker = null;
        let polygonMarkers = [];

        $(document).ready(function () {
            $("#navbar-container").load("navbarola.html", function () {
                console.log("Navbar loaded successfully!");
            });

            if (!localStorage.getItem("mid")) {
                window.location.href = "/index.html";
            }

            loadMapScript();
        });

        function loadMapScript() {
            const key = localStorage.getItem("key");
            if (!key) {
                console.error("No API key found in localStorage");
                return;
            }

            const script = document.createElement('script');
            script.src = `https://apis.mapmyindia.com/advancedmaps/api/${key}/map_sdk?layer=vector&v=2.0&callback=initMap`;
            script.defer = true;
            script.async = true;
            document.head.appendChild(script);
        }

        function initMap() {
            try {
                map = new MapmyIndia.Map('map', {
                    center: [28.61, 77.23],
                    zoomControl: true,
                    hybrid: true,
                    location: true,
                    zoom: 15,
                    click: true,
                    doubleClick: true,
                    mousedown: true,
                    mousemove: true,
                    mouseup: true
                });

                // Enable map interactions by default
                map.dragging = {
                    enable: function () {
                        if (map) map.dragPan.enable();
                    },
                    disable: function () {
                        if (map) map.dragPan.disable();
                    }
                };

                map.scrollWheelZoom = {
                    enable: function () {
                        if (map) map.scrollZoom.enable();
                    },
                    disable: function () {
                        if (map) map.scrollZoom.disable();
                    }
                };

                // Set default mode to hand (panning)
                setDrawingMode('hand');

                console.log("Map initialized successfully");
            } catch (error) {
                console.error("Error initializing map:", error);
            }
        }

        function setDrawingMode(mode, event) {
            try {
                cleanupDrawing();
                currentDrawingMode = mode;

                // Remove active class from all buttons
                document.querySelectorAll('.tool-button').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Add active class to clicked button if event exists
                if (event && event.currentTarget) {
                    event.currentTarget.classList.add('active');
                } else {
                    // If called programmatically, find and activate the corresponding button
                    document.querySelector(`.tool-button[onclick*="${mode}"]`)?.classList.add('active');
                }

                // Initialize the selected drawing mode
                switch (mode) {
                    case 'hand':
                        if (map && map.dragPan) {
                            map.dragPan.enable();
                            if (map.scrollZoom) map.scrollZoom.enable();
                        }
                        break;
                    case 'circle':
                        initializeCircleDrawing();
                        break;
                    case 'polygon':
                        initializePolygonDrawing();
                        break;
                }
            } catch (error) {
                console.error('Error in setDrawingMode:', error);
            }
        }

        function initializeMapPanning() {
            map.dragging.enable();
            map.scrollWheelZoom.enable();
        }

        $(document).ready(function () {
            $("#navbar-container").load("navbarola.html", function () {
                console.log("Navbar loaded successfully!");
            });

            if (!localStorage.getItem("mid")) {
                window.location.href = "/index.html";
            }

            loadMapScript();
        });

        function loadMapScript() {
            const key = localStorage.getItem("key");
            if (!key) {
                console.error("No API key found in localStorage");
                return;
            }

            const script = document.createElement('script');
            script.src = `https://apis.mapmyindia.com/advancedmaps/api/${key}/map_sdk?layer=vector&v=2.0&callback=initMap`;
            script.defer = true;
            script.async = true;
            document.head.appendChild(script);
        }

        function initMap() {
            try {
                map = new MapmyIndia.Map('map', {
                    center: [28.61, 77.23],
                    zoomControl: true,
                    hybrid: true,
                    location: true,
                    zoom: 15
                });

                // Wait for map to load before enabling interactions
                map.once('load', function () {
                    console.log("Map loaded successfully");

                    // Enable map interactions by default
                    map.dragPan.enable();
                    map.scrollZoom.enable();

                    // Set default mode to hand (panning)
                    setDrawingMode('hand');
                });

            } catch (error) {
                console.error("Error initializing map:", error);
            }
        }

        // function cleanupDrawing() {
        //     try {
        //         // Clean up circle
        //         if (circleMarker) {
        //             if (typeof circleMarker.remove === 'function') {
        //                 circleMarker.remove();
        //             } else if (map) {
        //                 map.removeLayer(circleMarker);
        //             }
        //             circleMarker = null;
        //         }

        //         // Clean up polygon and polyline
        //         if (tempPolyline) {
        //             if (typeof tempPolyline.remove === 'function') {
        //                 tempPolyline.remove();
        //             } else if (map) {
        //                 map.removeLayer(tempPolyline);
        //             }
        //             tempPolyline = null;
        //         }

        //         // Clean up polygon markers
        //         polygonMarkers.forEach(marker => {
        //             if (typeof marker.remove === 'function') {
        //                 marker.remove();
        //             } else if (map) {
        //                 map.removeLayer(marker);
        //             }
        //         });
        //         polygonMarkers = [];

        //         // Reset polygon path
        //         polygonPath = [];

        //         // Re-enable map interactions
        //         if (map) {
        //             if (map.dragPan) {
        //                 map.dragPan.enable();
        //             }
        //             if (map.scrollZoom) {
        //                 map.scrollZoom.enable();
        //             }
        //         }
        //     } catch (error) {
        //         console.error('Error in cleanupDrawing:', error);
        //     }
        // }

        function initializeMapPanning() {
            try {
                if (map) {
                    if (map.dragPan) {
                        map.dragPan.enable();
                    }
                    if (map.scrollZoom) {
                        map.scrollZoom.enable();
                    }
                }

            } catch (error) {
                console.error('Error in initializeMapPanning:', error);
            }
        }

        function initializeCircleDrawing() {
            try {
                if (!map) {
                    console.error("Map not initialized");
                    return;
                }

                if (map.dragPan) {
                    map.dragPan.disable();
                }

                let isDrawing = false;
                let center = null;

                // Create a source for the circle if it doesn't exist
                if (!map.getSource('circle-source')) {
                    map.addSource('circle-source', {
                        'type': 'geojson',
                        'data': {
                            'type': 'Feature',
                            'geometry': {
                                'type': 'Point',
                                'coordinates': [0, 0]
                            },
                            'properties': {
                                'radius': 0
                            }
                        }
                    });
                }

                // Add circle layer if it doesn't exist
                if (!map.getLayer('circle-fill')) {
                    map.addLayer({
                        'id': 'circle-fill',
                        'type': 'fill',
                        'source': 'circle-source',
                        'paint': {
                            'fill-color': '#FF0000',
                            'fill-opacity': 0.35
                        }
                    });
                }

                if (!map.getLayer('circle-stroke')) {
                    map.addLayer({
                        'id': 'circle-stroke',
                        'type': 'line',
                        'source': 'circle-source',
                        'paint': {
                            'line-color': '#FF0000',
                            'line-width': 2,
                            'line-opacity': 0.8
                        }
                    });
                }

                // Function to create circle geometry
                function createCircleGeometry(center, radius) {
                    const points = 64;
                    const coords = [];

                    for (let i = 0; i <= points; i++) {
                        const angle = (i * 360) / points;
                        const radians = (angle * Math.PI) / 180;

                        // Convert radius from meters to degrees (approximate)
                        const radiusInDegrees = radius / (111300 * Math.cos(center[1] * Math.PI / 180));

                        coords.push([
                            center[0] + radiusInDegrees * Math.cos(radians),
                            center[1] + radiusInDegrees * Math.sin(radians)
                        ]);
                    }

                    return {
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Polygon',
                            'coordinates': [coords]
                        },
                        'properties': {
                            'radius': radius
                        }
                    };
                }

                // Handle mouse down - start drawing
                map.on('mousedown', function (e) {
                    if (currentDrawingMode !== 'circle') return;

                    isDrawing = true;
                    center = [e.lngLat.lng, e.lngLat.lat];

                    // Create initial circle
                    const initialCircle = createCircleGeometry(center, 1);
                    map.getSource('circle-source').setData(initialCircle);
                });

                // Handle mouse move - update circle
                map.on('mousemove', function (e) {
                    if (!isDrawing || !center) return;

                    const currentPoint = [e.lngLat.lng, e.lngLat.lat];

                    const radius = calculateDistance(
                        center[1],
                        center[0],
                        currentPoint[1],
                        currentPoint[0]
                    );

                    // Update circle
                    const updatedCircle = createCircleGeometry(center, radius);
                    map.getSource('circle-source').setData(updatedCircle);
                });

                // Handle mouse up - finish drawing
                map.on('mouseup', function (e) {
                    if (!isDrawing) return;

                    isDrawing = false;

                    if (center) {
                        const endPoint = [e.lngLat.lng, e.lngLat.lat];
                        const finalRadius = calculateDistance(
                            center[1],
                            center[0],
                            endPoint[1],
                            endPoint[0]
                        );

                        currentShape = {
                            type: 'circle',
                            center: {
                                lat: center[1],
                                lng: center[0]
                            },
                            radius: finalRadius
                        };

                        showNamePopup();
                    }
                });

                // Add escape key handler
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') {
                        isDrawing = false;
                        // Clear the circle
                        if (map.getSource('circle-source')) {
                            map.getSource('circle-source').setData({
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Polygon',
                                    'coordinates': [[]]
                                }
                            });
                        }
                        if (map.dragPan) {
                            map.dragPan.enable();
                        }
                    }
                });

            } catch (error) {
                console.error('Error in initializeCircleDrawing:', error);
                if (map.dragPan) {
                    map.dragPan.enable();
                }
            }
        }


        // Update cleanupDrawing function
        function cleanupDrawing() {
            try {
                // For circles, just null the reference
                // MapMyIndia should clean up the old circle when reference is lost
                circleMarker = null;

                // Re-enable map interactions
                if (map && map.dragPan) {
                    map.dragPan.enable();
                }
            } catch (error) {
                console.error('Error in cleanupDrawing:', error);
            }
        }


        // Add error handling for the map
        map.on('error', function (error) {
            console.error('Map error:', error);
            cleanupDrawing();
        });


        // Add error handling for the map
        map.on('error', function (error) {
            console.error('Map error:', error);
            cleanupDrawing();
        });


        function initializePolygonDrawing() {
            try {
                if (!map) {
                    console.error("Map not initialized");
                    return;
                }

                if (map.dragPan) {
                    map.dragPan.disable();
                }

                let isDrawing = false;
                polygonPath = [];

                // Create a source for the polygon if it doesn't exist
                if (!map.getSource('polygon-source')) {
                    map.addSource('polygon-source', {
                        'type': 'geojson',
                        'data': {
                            'type': 'Feature',
                            'geometry': {
                                'type': 'Polygon',
                                'coordinates': [[]]
                            }
                        }
                    });
                }

                // Add polygon fill layer if it doesn't exist
                if (!map.getLayer('polygon-fill')) {
                    map.addLayer({
                        'id': 'polygon-fill',
                        'type': 'fill',
                        'source': 'polygon-source',
                        'paint': {
                            'fill-color': '#FF0000',
                            'fill-opacity': 0.35
                        }
                    });
                }

                // Add polygon outline layer if it doesn't exist
                if (!map.getLayer('polygon-outline')) {
                    map.addLayer({
                        'id': 'polygon-outline',
                        'type': 'line',
                        'source': 'polygon-source',
                        'paint': {
                            'line-color': '#FF0000',
                            'line-width': 2,
                            'line-opacity': 0.8
                        }
                    });
                }

                // Add vertex points layer if it doesn't exist
                if (!map.getLayer('polygon-vertices')) {
                    map.addLayer({
                        'id': 'polygon-vertices',
                        'type': 'circle',
                        'source': 'polygon-source',
                        'paint': {
                            'circle-radius': 5,
                            'circle-color': '#FFFFFF',
                            'circle-stroke-color': '#FF0000',
                            'circle-stroke-width': 2
                        },
                        'filter': ['in', '$type', 'Point']
                    });
                }

                // Function to update the polygon visualization
                function updatePolygonVisualization(path, includeTempPoint = false) {
                    // Create vertices feature collection
                    const vertices = {
                        'type': 'FeatureCollection',
                        'features': path.map(point => ({
                            'type': 'Feature',
                            'geometry': {
                                'type': 'Point',
                                'coordinates': [point.lng, point.lat]
                            }
                        }))
                    };

                    // Create polygon coordinates
                    let polygonCoords = path.map(point => [point.lng, point.lat]);

                    // Close the polygon if we have enough points
                    if (polygonCoords.length >= 3) {
                        polygonCoords.push(polygonCoords[0]); // Close the polygon
                    }

                    // Update the source data
                    map.getSource('polygon-source').setData({
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Polygon',
                            'coordinates': polygonCoords.length >= 3 ? [polygonCoords] : []
                        }
                    });
                }

                // Function to check if point is near the first point
                function isNearFirstPoint(point) {
                    if (polygonPath.length < 3) return false;

                    const firstPoint = polygonPath[0];
                    const distance = calculateDistance(
                        firstPoint.lat,
                        firstPoint.lng,
                        point.lat,
                        point.lng
                    );
                    return distance < 10; // Threshold in meters
                }

                // Handle click to add points
                map.on('click', function (e) {
                    if (currentDrawingMode !== 'polygon') return;

                    const clickPoint = e.lngLat;

                    // Check if clicking near the first point to close the polygon
                    if (polygonPath.length >= 3 && isNearFirstPoint(clickPoint)) {
                        // Complete the polygon
                        polygonPath.push(polygonPath[0]); // Close the path
                        currentShape = {
                            type: 'polygon',
                            coordinates: polygonPath.map(p => [p.lat, p.lng])
                        };
                        showNamePopup();
                        return;
                    }

                    // Add the new point
                    polygonPath.push(clickPoint);
                    updatePolygonVisualization(polygonPath);
                });

                // Handle mouse move to show preview
                map.on('mousemove', function (e) {
                    if (currentDrawingMode !== 'polygon' || polygonPath.length === 0) return;

                    const movePoint = e.lngLat;
                    if (polygonPath.length >= 3 && isNearFirstPoint(movePoint)) {
                        map.getCanvas().style.cursor = 'pointer'; // Change to pointer when can close
                    } else {
                        map.getCanvas().style.cursor = 'crosshair'; // Keep plus cursor otherwise
                    }

                    let previewPath = [...polygonPath];

                    if (polygonPath.length >= 3 && isNearFirstPoint(movePoint)) {
                        previewPath.push(polygonPath[0]); // Snap to first point
                    } else {
                        previewPath.push(movePoint);
                    }

                    updatePolygonVisualization(previewPath, true);
                });

                // Handle double click to complete polygon
                map.on('dblclick', function (e) {
                    if (currentDrawingMode !== 'polygon' || polygonPath.length < 3) return;

                    e.preventDefault();

                    currentShape = {
                        type: 'polygon',
                        coordinates: polygonPath.map(p => [p.lat, p.lng])
                    };
                    showNamePopup();
                });

                // Add escape key handler
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') {
                        // Clear the polygon
                        polygonPath = [];
                        if (map.getSource('polygon-source')) {
                            map.getSource('polygon-source').setData({
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Polygon',
                                    'coordinates': [[]]
                                }
                            });
                        }
                        if (map.dragPan) {
                            map.dragPan.enable();
                        }
                    }
                });

            } catch (error) {
                console.error('Error in initializePolygonDrawing:', error);
                if (map.dragPan) {
                    map.dragPan.enable();
                }
            }
        }


        function isNearFirstPoint(point) {
            if (polygonPath.length < 3) return false;
            const firstPoint = polygonPath[0];
            const distance = calculateDistance(
                firstPoint.lat,
                firstPoint.lng,
                point.lat,
                point.lng
            );
            return distance < 0.0001; // Adjust threshold as needed
        }

        function completePolygon() {
            if (tempPolyline) {
                tempPolyline.setMap(null);
            }

            currentShape = {
                type: 'polygon',
                coordinates: polygonPath.map(p => [p.lat, p.lng])
            };

            // Create final polygon
            const polygon = new MapmyIndia.Polygon({
                map: map,
                paths: polygonPath,
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35
            });

            showNamePopup();
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        function showNamePopup() {
            const popup = document.getElementById('namePopup');
            const nameInput = document.getElementById('fenceName');
            nameInput.value = '';
            popup.classList.add('active');
            nameInput.focus();
        }

        function cancelFence() {
            document.getElementById('namePopup').classList.remove('active');
            cleanupDrawing();
            currentDrawingMode = null;

            // Reset active state of tool buttons
            document.querySelectorAll('.tool-button').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function saveFence() {
            const name = document.getElementById('fenceName').value;
            if (!name || !currentShape) return;

            const mid = localStorage.getItem('mid');
            if (!mid) {
                console.error('mid not found in local storage.');
                alert('User ID (mid) not found. Please set mid in localStorage.');
                return;
            }

            let url = '';

            if (currentShape.type === 'circle') {
                const lat = currentShape.center.lat;
                const lng = currentShape.center.lng;
                const radius = currentShape.radius;

                url = `${API}opr=savefence&fvalue=${lat},${lng},${radius}&fname=${encodeURIComponent(name)}&ftype=circle&mid=${encodeURIComponent(mid)}`;
            } else if (currentShape.type === 'polygon') {
                const coordPairs = currentShape.coordinates.map(c => `${c[0]},${c[1]}`).join(',');
                url = `${API}opr=savefence&fvalue=${coordPairs}&fname=${encodeURIComponent(name)}&ftype=polygon&mid=${encodeURIComponent(mid)}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data[0].msg === "0") {
                        cleanupDrawing();
                        document.getElementById('namePopup').classList.remove('active');
                        currentDrawingMode = null;

                        // Reset active state of tool buttons
                        document.querySelectorAll('.tool-button').forEach(btn => {
                            btn.classList.remove('active');
                        });

                        alert("Successfully added the fence.");
                    } else {
                        throw new Error('Failed to save fence.');
                    }
                })
                .catch(error => {
                    console.error('Error saving fence:', error);
                    alert('Error saving fence. Please try again.');
                });
        }

        function cleanupDrawing() {
            try {
                // Clean up circle
                if (circleMarker) {
                    if (circleMarker.remove) {
                        circleMarker.remove();
                    } else if (map && map.removeLayer) {
                        map.removeLayer(circleMarker);
                    }
                    circleMarker = null;
                }

                // Clean up polygon
                if (tempPolyline) {
                    if (tempPolyline.remove) {
                        tempPolyline.remove();
                    } else if (map && map.removeLayer) {
                        map.removeLayer(tempPolyline);
                    }
                    tempPolyline = null;
                }

                // Clean up polygon markers
                polygonMarkers.forEach(marker => {
                    if (marker.remove) {
                        marker.remove();
                    } else if (map && map.removeLayer) {
                        map.removeLayer(marker);
                    }
                });
                polygonMarkers = [];

                // Reset polygon path
                polygonPath = [];

                // Enable map interactions
                if (map) {
                    if (map.dragPan) map.dragPan.enable();
                    if (map.scrollZoom) map.scrollZoom.enable();
                }
            } catch (error) {
                console.error('Error in cleanupDrawing:', error);
            }
        }

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const suggestionsContainer = document.getElementById('suggestions');
        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();

            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (!query) {
                suggestionsContainer.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                searchPlaces(query);
            }, 300);
        });

        async function searchPlaces(query) {
            const key = localStorage.getItem("key");
            try {
                const response = await fetch(`https://apis.mapmyindia.com/advancedmaps/v1/${key}/geo_code?addr=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.results && Array.isArray(data.results)) {
                    displaySuggestions(data.results);
                }
            } catch (error) {
                console.error('Error searching places:', error);
            }
        }

        function displaySuggestions(results) {
            suggestionsContainer.innerHTML = '';

            if (results.length > 0) {
                results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = result.formatted_address;

                    div.addEventListener('click', () => {
                        handlePlaceSelection(result);
                    });

                    suggestionsContainer.appendChild(div);
                });

                suggestionsContainer.style.display = 'block';
            } else {
                suggestionsContainer.style.display = 'none';
            }
        }

        function handlePlaceSelection(place) {
            searchInput.value = place.formatted_address;
            suggestionsContainer.style.display = 'none';

            // Center map on selected location
            if (place.lat && place.lng) {
                map.setCenter([place.lat, place.lng]);
                map.setZoom(15);
            }
        }

        // Close suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.style.display = 'none';
            }
        });

        // Handle escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                cancelFence();
            }
        });
    </script>

    <script src="js/api.js"></script>
</body>

</html>