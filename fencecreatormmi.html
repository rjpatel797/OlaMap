<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fence Creator with MapMyIndia</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #navbar-container {
            width: 100%;
            background-color: #333;
            color: white;
            padding: 0;
        }

        .search-bar {
            padding: 15px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1;
        }

        .search-box {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .search-label {
            font-weight: bold;
            color: #333;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .drawing-tools {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1;
        }

        .tool-button {
            width: 36px;
            height: 36px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-button.active {
            background: #e3f2fd;
            border-color: #2196F3;
        }

        .name-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }

        .name-popup.active {
            display: block;
        }

        .popup-content {
            min-width: 300px;
        }

        .name-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .popup-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .popup-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .cancel-btn {
            background: #f5f5f5;
        }

        .add-btn {
            background: #2196F3;
            color: white;
        }

        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .suggestion-item:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="navbar-container"></div>
        <div class="search-bar">
            <div class="search-box">
                <label class="search-label">Place:</label>
                <input type="text" id="searchInput" class="search-input" placeholder="Search places...">
                <div id="suggestions" class="suggestions-container"></div>
            </div>
        </div>
        <div class="map-container">
            <div id="map"></div>
            <div class="drawing-tools">
                <button class="tool-button" onclick="setDrawingMode('hand', event)" title="Pan Map">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 1 1 3 0m-3 6a1.5 1.5 0 0 0-3 0v2a7.5 7.5 0 0 0 15 0v-4a1.5 1.5 0 0 0-3 0m3-6V11m0-5.5v-1a1.5 1.5 0 0 1 3 0v1m0 0V11m0-5.5a1.5 1.5 0 0 1 3 0v3m0 0V11"/>
                    </svg>
                </button>
                <button class="tool-button" onclick="setDrawingMode('circle', event)" title="Draw Circle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                    </svg>
                </button>
                <button class="tool-button" onclick="setDrawingMode('polygon', event)" title="Draw Polygon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="name-popup" id="namePopup">
            <div class="popup-content">
                <label for="fenceName">Name:</label>
                <input type="text" id="fenceName" class="name-input">
                <div class="popup-buttons">
                    <button class="popup-button cancel-btn" onclick="cancelFence()">Cancel</button>
                    <button class="popup-button add-btn" onclick="saveFence()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let currentDrawingMode = null;
        let currentShape = null;
        let drawingLayers = [];
        let polygonPath = [];
        let tempPolyline = null;
        let circleMarker = null;
        let polygonMarkers = [];

        $(document).ready(function() {
            $("#navbar-container").load("navbarola.html", function() {
                console.log("Navbar loaded successfully!");
            });

            if (!localStorage.getItem("mid")) {
                window.location.href = "/index.html";
            }

            loadMapScript();
        });

        function loadMapScript() {
            const key = localStorage.getItem("key");
            if (!key) {
                console.error("No API key found in localStorage");
                return;
            }

            const script = document.createElement('script');
            script.src = `https://apis.mapmyindia.com/advancedmaps/api/${key}/map_sdk?layer=vector&v=2.0&callback=initMap`;
            script.defer = true;
            script.async = true;
            document.head.appendChild(script);
        }

        function initMap() {
            try {
                map = new MapmyIndia.Map('map', {
                    center: [28.61, 77.23],
                    zoomControl: true,
                    hybrid: true,
                    location: true,
                    zoom: 15,
                    click: true,
                    doubleClick: true,
                    mousedown: true,
                    mousemove: true,
                    mouseup: true
                });

                // Enable map interactions by default
                map.dragging = {
                    enable: function() {
                        if (map) map.dragPan.enable();
                    },
                    disable: function() {
                        if (map) map.dragPan.disable();
                    }
                };

                map.scrollWheelZoom = {
                    enable: function() {
                        if (map) map.scrollZoom.enable();
                    },
                    disable: function() {
                        if (map) map.scrollZoom.disable();
                    }
                };

                // Set default mode to hand (panning)
                setDrawingMode('hand');

                console.log("Map initialized successfully");
            } catch (error) {
                console.error("Error initializing map:", error);
            }
        }

        function setDrawingMode(mode, event) {
            try {
                cleanupDrawing();
                currentDrawingMode = mode;

                // Remove active class from all buttons
                document.querySelectorAll('.tool-button').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Add active class to clicked button if event exists
                if (event && event.currentTarget) {
                    event.currentTarget.classList.add('active');
                } else {
                    // If called programmatically, find and activate the corresponding button
                    document.querySelector(`.tool-button[onclick*="${mode}"]`)?.classList.add('active');
                }

                // Initialize the selected drawing mode
                switch (mode) {
                    case 'hand':
                        if (map && map.dragPan) {
                            map.dragPan.enable();
                            if (map.scrollZoom) map.scrollZoom.enable();
                        }
                        break;
                    case 'circle':
                        initializeCircleDrawing();
                        break;
                    case 'polygon':
                        initializePolygonDrawing();
                        break;
                }
            } catch (error) {
                console.error('Error in setDrawingMode:', error);
            }
        }

        function initializeMapPanning() {
            map.dragging.enable();
            map.scrollWheelZoom.enable();
        }

        $(document).ready(function() {
            $("#navbar-container").load("navbarola.html", function() {
                console.log("Navbar loaded successfully!");
            });

            if (!localStorage.getItem("mid")) {
                window.location.href = "/index.html";
            }

            loadMapScript();
        });

        function loadMapScript() {
            const key = localStorage.getItem("key");
            if (!key) {
                console.error("No API key found in localStorage");
                return;
            }

            const script = document.createElement('script');
            script.src = `https://apis.mapmyindia.com/advancedmaps/api/${key}/map_sdk?layer=vector&v=2.0&callback=initMap`;
            script.defer = true;
            script.async = true;
            document.head.appendChild(script);
        }

        function initMap() {
            try {
                map = new MapmyIndia.Map('map', {
                    center: [28.61, 77.23],
                    zoomControl: true,
                    hybrid: true,
                    location: true,
                    zoom: 15
                });

                // Wait for map to load before enabling interactions
                map.once('load', function() {
                    console.log("Map loaded successfully");
                    
                    // Enable map interactions by default
                    map.dragPan.enable();
                    map.scrollZoom.enable();

                    // Set default mode to hand (panning)
                    setDrawingMode('hand');
                });

            } catch (error) {
                console.error("Error initializing map:", error);
            }
        }

        function cleanupDrawing() {
            try {
                // Clean up circle
                if (circleMarker) {
                    if (typeof circleMarker.remove === 'function') {
                        circleMarker.remove();
                    } else if (map) {
                        map.removeLayer(circleMarker);
                    }
                    circleMarker = null;
                }

                // Clean up polygon and polyline
                if (tempPolyline) {
                    if (typeof tempPolyline.remove === 'function') {
                        tempPolyline.remove();
                    } else if (map) {
                        map.removeLayer(tempPolyline);
                    }
                    tempPolyline = null;
                }

                // Clean up polygon markers
                polygonMarkers.forEach(marker => {
                    if (typeof marker.remove === 'function') {
                        marker.remove();
                    } else if (map) {
                        map.removeLayer(marker);
                    }
                });
                polygonMarkers = [];

                // Reset polygon path
                polygonPath = [];

                // Re-enable map interactions
                if (map) {
                    if (map.dragPan) {
                        map.dragPan.enable();
                    }
                    if (map.scrollZoom) {
                        map.scrollZoom.enable();
                    }
                }
            } catch (error) {
                console.error('Error in cleanupDrawing:', error);
            }
        }

        function initializeMapPanning() {
            try {
                if (map) {
                    if (map.dragPan) {
                        map.dragPan.enable();
                    }
                    if (map.scrollZoom) {
                        map.scrollZoom.enable();
                    }
                }
            } catch (error) {
                console.error('Error in initializeMapPanning:', error);
            }
        }

        function initializeCircleDrawing() {
    try {
        if (!map) {
            console.error("Map not initialized");
            return;
        }

        if (map.dragPan) {
            map.dragPan.disable();
        }
        
        let isDrawing = false;
        let center = null;
        let startPoint = null;
        let currentRadius = 0;

        map.on('mousedown', function(e) {
            if (currentDrawingMode !== 'circle') return;
            isDrawing = true;

            // Get initial click position
            const lngLat = e.lngLat;
            center = { lng: lngLat.lng, lat: lngLat.lat };
            startPoint = lngLat;
            
            // Remove existing circle if any
            if (circleMarker) {
                circleMarker.setMap(null);
                circleMarker = null;
            }

            // Create initial circle
            circleMarker = new MapmyIndia.Circle({
                map: map,
                center: center,
                radius: 1,
                circleOptions: {
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FF0000',
                    fillOpacity: 0.35
                }
            });
        });

        map.on('mousemove', function(e) {
            if (!isDrawing || !startPoint) return;
            
            const currentPoint = e.lngLat;
            currentRadius = calculateDistance(
                startPoint.lat,
                startPoint.lng,
                currentPoint.lat,
                currentPoint.lng
            );

            // Remove existing circle
            if (circleMarker) {
                circleMarker.setMap(null);
            }

            // Create new circle with updated radius
            circleMarker = new MapmyIndia.Circle({
                map: map,
                center: center,
                radius: currentRadius,
                circleOptions: {
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FF0000',
                    fillOpacity: 0.35
                }
            });
        });

        map.on('mouseup', function() {
            if (!isDrawing) return;
            isDrawing = false;
            
            if (circleMarker && currentRadius > 0) {
                currentShape = {
                    type: 'circle',
                    center: center,
                    radius: currentRadius
                };
                showNamePopup();
            }
        });

    } catch (error) {
        console.error('Error in initializeCircleDrawing:', error);
    }
}

// Add error handling for the map
            map.on('error', function(error) {
                console.error('Map error:', error);
                cleanupDrawing();
            });
        

            // Add error handling for the map
            map.on('error', function(error) {
                console.error('Map error:', error);
                cleanupDrawing();
            });
        

        function initializePolygonDrawing() {
            
                if (!map) {
                    console.error("Map not initialized");
                    return;
                }

                if (map.dragPan) {
                    map.dragPan.disable();
                }
                
                polygonPath = [];

                map.on('click', function(e) {
                if (currentDrawingMode !== 'polygon') return;

                polygonPath.push(e.latlng);
                
                // Add marker for vertex
                const marker = new MapmyIndia.Marker({
                    map: map,
                    position: e.latlng,
                    draggable: false
                });
                polygonMarkers.push(marker);

                // Update or create polyline
                if (tempPolyline) {
                    tempPolyline.setMap(null);
                }
                if (polygonPath.length > 1) {
                    tempPolyline = new MapmyIndia.Polyline({
                        map: map,
                        path: polygonPath,
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 2
                    });
                }

                // Check if polygon should be completed
                if (polygonPath.length > 2 && isNearFirstPoint(e.latlng)) {
                    completePolygon();
                }
            })

            // Double click to complete polygon
            map.on('dblclick', function(e) {
                if (currentDrawingMode !== 'polygon' || polygonPath.length < 3) return;
                e.preventDefault();
                completePolygon();
            });
        
        }

        function isNearFirstPoint(point) {
            if (polygonPath.length < 3) return false;
            const firstPoint = polygonPath[0];
            const distance = calculateDistance(
                firstPoint.lat,
                firstPoint.lng,
                point.lat,
                point.lng
            );
            return distance < 0.0001; // Adjust threshold as needed
        }

        function completePolygon() {
            if (tempPolyline) {
                tempPolyline.setMap(null);
            }

            currentShape = {
                type: 'polygon',
                coordinates: polygonPath.map(p => [p.lat, p.lng])
            };

            // Create final polygon
            const polygon = new MapmyIndia.Polygon({
                map: map,
                paths: polygonPath,
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35
            });

            showNamePopup();
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function showNamePopup() {
            const popup = document.getElementById('namePopup');
            const nameInput = document.getElementById('fenceName');
            nameInput.value = '';
            popup.classList.add('active');
            nameInput.focus();
        }

        function cancelFence() {
            document.getElementById('namePopup').classList.remove('active');
            cleanupDrawing();
            currentDrawingMode = null;

            // Reset active state of tool buttons
            document.querySelectorAll('.tool-button').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function saveFence() {
            const name = document.getElementById('fenceName').value;
            if (!name || !currentShape) return;

            const mid = localStorage.getItem('mid');
            if (!mid) {
                console.error('mid not found in local storage.');
                alert('User ID (mid) not found. Please set mid in localStorage.');
                return;
            }

            let url = '';

            if (currentShape.type === 'circle') {
                const lat = currentShape.center.lat;
                const lng = currentShape.center.lng;
                const radius = currentShape.radius;

                url = `${API}opr=savefence&fvalue=${lat},${lng},${radius}&fname=${encodeURIComponent(name)}&ftype=circle&mid=${encodeURIComponent(mid)}`;
            } else if (currentShape.type === 'polygon') {
                const coordPairs = currentShape.coordinates.map(c => `${c[0]},${c[1]}`).join(',');
                url = `${API}opr=savefence&fvalue=${coordPairs}&fname=${encodeURIComponent(name)}&ftype=polygon&mid=${encodeURIComponent(mid)}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data[0].msg === "0") {
                        cleanupDrawing();
                        document.getElementById('namePopup').classList.remove('active');
                        currentDrawingMode = null;

                        // Reset active state of tool buttons
                        document.querySelectorAll('.tool-button').forEach(btn => {
                            btn.classList.remove('active');
                        });

                        alert("Successfully added the fence.");
                    } else {
                        throw new Error('Failed to save fence.');
                    }
                })
                .catch(error => {
                    console.error('Error saving fence:', error);
                    alert('Error saving fence. Please try again.');
                });
        }

        function cleanupDrawing() {
            try {
                // Clean up circle
                if (circleMarker) {
                    if (circleMarker.remove) {
                        circleMarker.remove();
                    } else if (map && map.removeLayer) {
                        map.removeLayer(circleMarker);
                    }
                    circleMarker = null;
                }

                // Clean up polygon
                if (tempPolyline) {
                    if (tempPolyline.remove) {
                        tempPolyline.remove();
                    } else if (map && map.removeLayer) {
                        map.removeLayer(tempPolyline);
                    }
                    tempPolyline = null;
                }

                // Clean up polygon markers
                polygonMarkers.forEach(marker => {
                    if (marker.remove) {
                        marker.remove();
                    } else if (map && map.removeLayer) {
                        map.removeLayer(marker);
                    }
                });
                polygonMarkers = [];

                // Reset polygon path
                polygonPath = [];
            
                // Enable map interactions
                if (map) {
                    if (map.dragPan) map.dragPan.enable();
                    if (map.scrollZoom) map.scrollZoom.enable();
                }
            } catch (error) {
                console.error('Error in cleanupDrawing:', error);
            }
        }

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const suggestionsContainer = document.getElementById('suggestions');
        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();

            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (!query) {
                suggestionsContainer.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                searchPlaces(query);
            }, 300);
        });

        async function searchPlaces(query) {
            const key = localStorage.getItem("key");
            try {
                const response = await fetch(`https://apis.mapmyindia.com/advancedmaps/v1/${key}/geo_code?addr=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.results && Array.isArray(data.results)) {
                    displaySuggestions(data.results);
                }
            } catch (error) {
                console.error('Error searching places:', error);
            }
        }

        function displaySuggestions(results) {
            suggestionsContainer.innerHTML = '';

            if (results.length > 0) {
                results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = result.formatted_address;
                    
                    div.addEventListener('click', () => {
                        handlePlaceSelection(result);
                    });

                    suggestionsContainer.appendChild(div);
                });

                suggestionsContainer.style.display = 'block';
            } else {
                suggestionsContainer.style.display = 'none';
            }
        }

        function handlePlaceSelection(place) {
            searchInput.value = place.formatted_address;
            suggestionsContainer.style.display = 'none';

            // Center map on selected location
            if (place.lat && place.lng) {
                map.setCenter([place.lat, place.lng]);
                map.setZoom(15);
            }
        }

        // Close suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.style.display = 'none';
            }
        });

        // Handle escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                cancelFence();
            }
        });
    </script>

    <script src="js/api.js"></script>
</body>
</html>