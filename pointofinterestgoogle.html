<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POI Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Arial, sans-serif;
        }

        .navbar {
        background-color: #2d3e50;
        padding: 10px 20px;
        color: white;
        }

        .container {
        height: calc(100% - 200px); /* Adjust for table height */
        display: flex;
        flex-direction: column;
        }

        /* Ensure the map takes remaining space */
        #map {
        flex: 1;
        width: 100%;
        }


        .controls {
        padding: 10px;
        background-color: #f5f6f7;
        border-bottom: 1px solid #ddd;
        }

        .input-group {
        display: flex;
        gap: 10px;
        }

        input, select {
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        }

        button {
        padding: 8px 15px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        }

        /* Make the Submit button green */
        #submit {
            background-color: #2ecc71;
            /* Green */
            color: white;
        }

        #submit:hover {
            background-color: #27ae60;
            /* Darker green on hover */
        }

        /* Make the Disable All button red */
        #disableAll {
            background-color: #e74c3c;
            /* Red */
            color: white;
        }

        #disableAll:hover {
            background-color: #c0392b;
            /* Darker red on hover */
        }


        button:hover {
            background-color: #2980b9;
        }

        .poi-table {
            width: 100%;
            border-collapse: collapse;
        }

        .poi-table th,
        .poi-table td {
            padding: 3px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .poi-table th {
            background-color: #34495e;
            color: white;
        }

        .action-btn {
    cursor: pointer;
    padding: 6px;
    margin: 0 3px;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.enable-btn {
    color: #28a745;
}

.disable-btn {
    color: #ffc107;
}

.delete-btn {
    color: #dc3545;
}

.action-btn:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

/* Optional: Add transition for smooth hover effect */
.action-btn i {
    font-size: 16px;
    transition: transform 0.2s;
}

.action-btn:hover i {
    transform: scale(1.1);
}

        .search-bar {
            padding: 5px;
            background: #f5f6f7;
            border-bottom: 1px solid #ddd;
        }

        .search-container {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }

        #placeSearch {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .search-item:hover {
            background-color: #f8f9fa;
        }

        .table-container {
            max-height: 300px;  /* Set maximum height for the table container */
            overflow-y: auto;   /* Enable vertical scrolling */
            position: relative;
        }

        /* Make the header stick to the top */
        .poi-table thead th {
            position: sticky;
            top: 0;
            background-color: #34495e;
            z-index: 1;
        }

        /* Add some padding to the table body for better scrolling experience */
        .poi-table tbody td {
            padding: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px; /* Limit cell width */
        }

        /* Add a subtle shadow to the header when scrolling */
        .poi-table thead::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 100%;
            height: 4px;
            background: linear-gradient(180deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0) 100%);
        }

        /* Style scrollbar for better appearance */
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Ensure the container takes remaining space */
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #map {
            height: 50%;
        }

        .controls {
            flex-shrink: 0;
        }

        .table-container {
            flex: 1;
            min-height: 0; /* Important for proper flexbox scrolling */
        }

        /* Address column scrolling */
        .poi-table td:nth-child(5) {
    /* width: 500px; */
    white-space: nowrap;
    overflow-x: auto;
    text-align: left;
    /* display: block;  Added to ensure proper scrolling */
    text-overflow:initial;  /* Prevents ellipsis truncation */
    padding: 8px;  /* Added for better spacing */
}

/* Custom scrollbar styling for address column */
.poi-table td:nth-child(5)::-webkit-scrollbar {
    height: 4px;
}

.poi-table td:nth-child(5)::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.poi-table td:nth-child(5)::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 2px;
}

.poi-table td:nth-child(5)::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.poi-table td:nth-child(6):contains('Enable') {
    color: #27ae60;
}

.poi-table td:nth-child(6):contains('Disable') {
    color: #e74c3c;
}


    </style>
</head>
<body>
    <div class="container">
        <div id="navbar-container"></div>

        <div class="search-bar">
            <div class="search-container">
                <input type="text" id="placeSearch" placeholder="Search place...">
            </div>
        </div>

        <div id="map"></div>

        <div class="controls">
            <div class="input-group">
                <input type="text" id="location" placeholder="Location">
                <input type="text" id="latitude" placeholder="Latitude">
                <input type="text" id="longitude" placeholder="Longitude">
                <input type="text" id="address" placeholder="Address">
                <select id="status">
                    <option value="Enable">Enable</option>
                    <option value="Disable">Disable</option>
                </select>
                <button onclick="addPOI()" id="submit">Submit</button>
                <button onclick="enableAll()" id="enableAll">Enable All</button>
                <button onclick="disableAll()" id="disableAll">Disable All</button>
            </div>
        </div>

        <div class="table-container">
            <table class="poi-table">
                <thead>
                    <tr>
                        <th>Sr No.</th>
                        <th>Location</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        <th>Address</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="poiTableBody"></tbody>
            </table>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjSJzY7GgAuRw_Pf5tUCJU7oMm_rg0aWg&libraries=places&callback=initMap"
    async defer></script>
    <script>
       // Global variables
const mid = localStorage.getItem("mid");
let map;
let markers = [];
let searchBox;
let geocoder;

// Initialize Google Map
function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 28.6139, lng: 77.2090 },
        zoom: 12,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true
    });

    geocoder = new google.maps.Geocoder();
    
    // Initialize the Autocomplete service
    const input = document.getElementById('placeSearch');
    const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['geocode', 'establishment'],
        fields: ['place_id', 'geometry', 'formatted_address', 'name']
    });

    // Create a draggable marker
    let currentMarker = new google.maps.Marker({
        map: map,
        draggable: true,
        animation: google.maps.Animation.DROP,
        icon: {
            path: google.maps.SymbolPath.MARKER,
            scale: 12,
            fillColor: "#FF0000",
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: "#FFFFFF",
            labelOrigin: new google.maps.Point(0, -10)
        }
    });

    // Handle place selection
    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry || !place.geometry.location) {
            return;
        }
        handlePlaceSelection(place, currentMarker);
    });

    // Handle marker drag events
    google.maps.event.addListener(currentMarker, 'dragend', function(event) {
        handleMarkerDrag(event, currentMarker);
    });

    // Add marker animation on drag
    google.maps.event.addListener(currentMarker, 'dragstart', function() {
        currentMarker.setAnimation(google.maps.Animation.BOUNCE);
    });

    google.maps.event.addListener(currentMarker, 'dragend', function() {
        currentMarker.setAnimation(null);
    });

    // Store marker reference for later use
    markers.push(currentMarker);

    // Check for URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('lat') && urlParams.get('lng')) {
        initializeFromParams();
    }

    // Initial POI load
    fetchPOIs();
}

// Handle marker drag event
function handleMarkerDrag(event, marker) {
    const position = {
        lat: event.latLng.lat(),
        lng: event.latLng.lng()
    };
    
    // Reverse geocode the new position
    geocoder.geocode({ location: position }, (results, status) => {
        if (status === 'OK' && results[0]) {
            updateFormFields(
                position,
                results?.[0]?.address_components
                ?.slice(0, 3)
                ?.map(component => component.long_name)
                ?.join(', ') || '', 
                results[0].formatted_address );
        }
    });
}

// Helper function to update form fields
function updateFormFields(position, locationName, address) {
    document.getElementById('location').value = locationName || '';
    document.getElementById('latitude').value = position.lat;
    document.getElementById('longitude').value = position.lng;
    document.getElementById('address').value = address || '';
}

// Fetch POIs from API
async function fetchPOIs() {
    try {
        const response = await fetch(`${API}opr=getpoilistByMid&mid=${mid}`);
        const data = await response.json();
        if (Array.isArray(data)) {
                    updatePOITable(data);
                    // updateMapMarkers(data);
                } else {
                    console.error('Invalid data format received from API');
                }
    } catch (error) {
        console.error('Error fetching POIs:', error);
    }
}

// Handle place selection from search
function handlePlaceSelection(place, marker) {
    // Create position object with actual lat/lng values
    const position = {
        lat: place.geometry.location.lat(),  // Call lat() method
        lng: place.geometry.location.lng()   // Call lng() method
    };

    // Update form fields with the correct position object
    updateFormFields(
        position,
        place.name,
        place.formatted_address
    );

    // Center map with smooth animation
    map.panTo(place.geometry.location);
    map.setZoom(16);

    // Update marker
    if (marker) {
        marker.setPosition(place.geometry.location);
    }
}

// Update map markers
function updateMapMarkers(pois) {
    // Clear existing markers
    clearMarkers();

    // Add new markers
    pois.forEach(poi => {
        const position = { 
            lat: parseFloat(poi.latitude), 
            lng: parseFloat(poi.longitude) 
        };

        const marker = new google.maps.Marker({
            position: position,
            map: map,
            title: poi.location,
            icon: {
                path: google.maps.SymbolPath.MARKER,
                scale: 10,
                fillColor: poi.status === 'Enable' ? '#27ae60' : '#e74c3c',
                fillOpacity: 1,
                strokeWeight: 1,
                strokeColor: "#FFFFFF",
                labelOrigin: new google.maps.Point(0, -10)
            }
        });

        // Add info window
        const infowindow = new google.maps.InfoWindow({
            content: poi.location
        });

        marker.addListener('click', () => {
            infowindow.open(map, marker);
        });

        markers.push(marker);
    });
}

// Clear all markers
function clearMarkers() {
    markers.forEach(marker => marker.setMap(null));
    markers = [];
}

// Clear search marker
function clearSearchMarker() {
    if (markers.length > 0) {
        markers[markers.length - 1].setMap(null);
        markers.pop();
    }
}

// Add new POI
async function addPOI() {
    const location = document.getElementById('location').value;
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;
    const address = document.getElementById('address').value;
    const status = document.getElementById('status').value;

    const url = `${API}opr=addpoi&latitude=${latitude}&langitude=${longitude}&status=${status}&location=${location}&address=${address}&mid=${mid}`;

    try {
        const response = await fetch(url);
        if (response.ok) {
            fetchPOIs();
            clearInputs();
        }
    } catch (error) {
        console.error('Error adding POI:', error);
    }
}

// Update POI status
async function updateStatus(id, status) {
    try {
        const response = await fetch(`${API}?opr=updatepoi&id=${id}&status=${status}&mid=${mid}`);
        if (response.ok) {
            fetchPOIs();
        }
    } catch (error) {
        console.error('Error updating POI status:', error);
    }
}

// Delete POI
async function deletePOI(id) {
    if (confirm('Are you sure you want to delete this POI?')) {
        try {
            const response = await fetch(`${API}?opr=deletepoi&id=${id}&mid=${mid}`);
            if (response.ok) {
                fetchPOIs();
            }
        } catch (error) {
            console.error('Error deleting POI:', error);
        }
    }
}

// Update POI table
function updatePOITable(pois) {
    const tbody = document.getElementById('poiTableBody');
    tbody.innerHTML = '';

    console.log(JSON.stringify(pois))

    pois.forEach((poi, index) => {
        const row = `
            <tr data-id="${poi.id}">
                        <td>${index + 1}</td>
                        <td>${poi.plocation || ''}</td>
                        <td>${poi.latitude ? parseFloat(poi.latitude).toFixed(3) : ''}</td>
                        <td>${poi.langitude ? parseFloat(poi.langitude).toFixed(3) : ''}</td>
                        <td>${poi.address || ''}</td>
                        <td style="${poi.status === 'Disable' ? 'color: red;' : 'color: green;'}">${poi.status || 'Enable'}</td>
                        <td>
                            <span class="action-btn enable-btn" onclick="updateStatus(${poi.id}, 'Enable')" title="Enable">
                                <i class="fas fa-check-circle"></i>
                            </span>
                            <span class="action-btn disable-btn" onclick="updateStatus(${poi.id}, 'Disable')" title="Disable">
                                <i class="fas fa-ban"></i>
                            </span>
                            <span class="action-btn delete-btn" onclick="deletePOI(${poi.id})" title="Delete">
                                <i class="fas fa-trash-alt"></i>
                            </span>
                        </td>
                    </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

// Initialize from URL parameters
function initializeFromParams() {
    const urlParams = new URLSearchParams(window.location.search);
    const lat = parseFloat(urlParams.get('lat'));
    const lng = parseFloat(urlParams.get('lng'));
    const deviceName = urlParams.get('deviceName');

    if (lat && lng) {
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;
        
        if (deviceName) {
            document.getElementById('location').value = deviceName;
        }

        // Reverse geocode for address
        geocoder.geocode({ location: { lat, lng } }, (results, status) => {
            if (status === 'OK' && results[0]) {
                document.getElementById('address').value = results[0].formatted_address;
            }
        });

        // Center map and add marker
        const position = { lat, lng };
        map.setCenter(position);
        map.setZoom(16);

        clearMarkers();
        const marker = new google.maps.Marker({
            position: position,
            map: map,
            title: deviceName || 'Selected Location',
            icon: {
                path: google.maps.SymbolPath.MARKER,
                scale: 12,
                fillColor: "#FF0000",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "#FFFFFF",
                labelOrigin: new google.maps.Point(0, -10)
            }
        });
        markers.push(marker);
    }
}

// Utility functions
function enableAll() {
    document.querySelectorAll('.poi-table tbody tr').forEach(row => {
        const id = row.getAttribute('data-id');
        if (id) updateStatus(id, 'Enable');
    });
}

function disableAll() {
    document.querySelectorAll('.poi-table tbody tr').forEach(row => {
        const id = row.getAttribute('data-id');
        if (id) updateStatus(id, 'Disable');
    });
}

function clearInputs() {
    document.getElementById('location').value = '';
    document.getElementById('latitude').value = '';
    document.getElementById('longitude').value = '';
    document.getElementById('address').value = '';
    document.getElementById('status').value = 'Enable';
}

// Initialize on page load
$(document).ready(function() {
    $("#navbar-container").load("/navbarola.html", function(response, status, xhr) {
        if (status === "error") {
            console.error("Error loading navbar:", xhr.status, xhr.statusText);
        } else {
            console.log("Navbar loaded successfully!");
        }
    });

    if (!localStorage.getItem("mid")) {
        window.location.href = "/index.html";
    }
});

    </script>
    
</body>
</html>